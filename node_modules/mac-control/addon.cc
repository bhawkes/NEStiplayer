#include <ApplicationServices/ApplicationServices.h>
#include <node.h>
#include <v8.h>

using namespace v8;

//kCGEventFlagMaskControl
//kCGEventFlagMaskAlternate
//kCGEventFlagMaskCommand
//kCGEventFlagMaskSecondaryFn

Handle<Value> Press(const Arguments& args) {
        
    CGEventRef down = CGEventCreateKeyboardEvent(NULL, (CGKeyCode) args[0]->NumberValue(), true);

    if(args[1]->NumberValue() == 1){
        CGEventSetFlags(down, kCGEventFlagMaskShift);
    }

    CGEventPost(kCGHIDEventTap, down);
    CFRelease(down);

    return v8::Undefined();
}
 
Handle<Value> Release(const Arguments& args) {
    
    CGEventRef up = CGEventCreateKeyboardEvent(NULL, (CGKeyCode) args[0]->NumberValue(), false);
    
    if(args[1]->NumberValue() == 1){
        CGEventSetFlags(up, kCGEventFlagMaskShift);
    }
    
    CGEventPost(kCGHIDEventTap, up);
    CFRelease(up);

    return v8::Undefined();
}
 
void init(Handle<Object> target) {
    target->Set(String::NewSymbol("press"),
        FunctionTemplate::New(Press)->GetFunction());
 
    target->Set(String::NewSymbol("release"),
        FunctionTemplate::New(Release)->GetFunction());
}
NODE_MODULE(addon, init)